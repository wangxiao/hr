!function(){function a(a,b){var c=!1,d=document.getElementById(b);d.addEventListener("mousedown",function(b){var e,f;c=!0,e=b.clientX-d.offsetLeft+document.body.scrollLeft+document.documentElement.scrollLeft,f=b.clientY-d.offsetTop+document.body.scrollTop+document.documentElement.scrollTop,a.touchWater(e,f,1.5,c?finger:pixel)},!1),d.addEventListener("mouseup",function(){c=!1},!1),d.addEventListener("mousemove",function(b){var e=b.clientX-d.offsetLeft+document.body.scrollLeft+document.documentElement.scrollLeft,f=b.clientY-d.offsetTop+document.body.scrollTop+document.documentElement.scrollTop;a.touchWater(e,f,1.5,c?finger:pixel)},!1)}function b(a,b){var d,c=document.createElement("canvas");return c.setAttribute("width",a),c.setAttribute("height",b),pointerCtx=c.getContext("2d"),d=pointerCtx.createRadialGradient(a/2,b/2,0,a/2,b/2,b/2),d.addColorStop(0,"#fff"),d.addColorStop(1,"#fff"),pointerCtx.fillStyle=d,pointerCtx.fillRect(0,0,a,b),c}function c(a){var e,f,g,h,i,j,k,l,m,b=a.width,c=a.height,d=new Array(b);for(e=0;b>e;e++)for(d[e]=new Array(c),f=0;c>f;f++)d[e][f]=0;for(g=a.getContext("2d"),h=g.getImageData(0,0,b,c),i=h.data,j=0;n=i.length,n>j;j+=4)k=i[j],l=k/255,m=j/4,e=m%b,f=(m-e)/b,d[e][f]=l;return d}function d(d){var e,f,g;pixel=c(b(2,2)),raindrop=c(b(4,4)),finger=c(b(100,100)),e=($(document).width()-1024)/2,f=$("#"+d).height(),g=new WaterModel(e,f,{resolution:2,interpolate:!1,damping:.985,clipping:15,evolveThreshold:.05,maxFps:15,showStats:!1}),new WaterCanvas(e,f,d,g,{backgroundImageUrl:null,lightRefraction:9,lightReflection:.1,showStats:!1}),new RainMaker(e,f,g,raindrop),a(g,d)}WaterCanvas=function(a,b,c,d,e){if(e=e||{},this.backgroundImageUrl=e.backgroundImageUrl||null,this.lightRefraction=e.lightRefraction||9,this.lightReflection=e.lightReflection||.1,this.showStats=e.showStats||!1,this.width=a,this.height=b,this.documentElement=document.getElementById(c),this.waterModel=d,this.canvas=document.createElement("canvas"),this.canvasHelp=document.createElement("canvas"),!this.canvas.getContext||!this.canvasHelp.getContext)return alert("You need a browser that supports the HTML5 canvas tag."),void 0;if(this.ctx=this.canvas.getContext("2d"),this.ctxHelp=this.canvasHelp.getContext("2d"),this.setSize(a,b),this.documentElement.appendChild(this.canvas),this.fps=-1,this.showStats){this.fpsCounter=0,this.prevMs=0;var f=this;setInterval(function(){f.findFps()},1e3)}this.drawNextFrame()},WaterCanvas.prototype.setSize=function(a,b){this.width=a,this.height=b,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this.canvasHelp.setAttribute("width",this.width),this.canvasHelp.setAttribute("height",this.height),this.setBackground(this.backgroundImageUrl)},WaterCanvas.prototype.setBackground=function(a){var b,c,d;this.backgroundImageUrl=""==a?null:a,this.pixelsIn=null,null!=this.backgroundImageUrl?(this.backgroundImg=new Image,b=this,this.backgroundImg.onload=function(){b.ctxHelp.drawImage(b.backgroundImg,0,0,b.width,b.height);var a=b.ctxHelp.getImageData(0,0,b.width,b.height);b.pixelsIn=a.data,b.ctx.putImageData(a,0,0)},this.backgroundImg.src=this.backgroundImageUrl):(c=pointerCtx.createRadialGradient(this.width/2,this.height/2,0,this.width/2,this.height/2,this.height/2),c.addColorStop(0,"#fff"),c.addColorStop(1,"#fff"),this.ctxHelp.fillStyle=c,this.ctxHelp.fillRect(0,0,this.width,this.height),d=this.ctxHelp.getImageData(0,0,this.width,this.height),this.pixelsIn=d.data,this.ctx.putImageData(d,0,0))},WaterCanvas.prototype.drawNextFrame=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,o,p;if(null==this.pixelsIn||!this.waterModel.isEvolving())return a=this,setTimeout(function(){a.drawNextFrame()},50),void 0;for(b=this.ctx.getImageData(0,0,this.width,this.height),c=b.data,d=0;n=c.length,n>d;d+=4)e=d/4,f=e%this.width,g=(e-f)/this.width,h=this.waterModel.getWater(f,g),i=Math.round(h*this.lightRefraction),j=f+i,k=g+i,0>j&&(j=0),0>k&&(k=0),j>this.width-1&&(j=this.width-1),k>this.height-1&&(k=this.height-1),l=4*(k*this.width+j),m=this.pixelsIn[l],o=this.pixelsIn[l+1],p=this.pixelsIn[l+2],h*=this.lightReflection,h+=1,c[d]=m*=h,c[d+1]=o*=h,c[d+2]=p*=h,c[d+3]=255;this.ctx.putImageData(b,0,0),this.showStats&&(this.fpsCounter++,this.ctx.textBaseline="top",this.ctx.font="normal 200 10px arial",this.ctx.fillStyle="white",this.ctx.fillText("FPS Canvas: "+this.getFps(),10,10),this.ctx.fillText("FPS Water: "+this.waterModel.getFps(),10,20),this.ctx.shadowColor="black",this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.shadowBlur=2),a=this,requestAnimFrame(function(){a.drawNextFrame()},this.canvas)},WaterCanvas.prototype.findFps=function(){var a,b;this.showStats&&(a=(new Date).getTime(),b=a-this.prevMs,this.fps=Math.round(10*(1e3*this.fpsCounter/b))/10,this.prevMs=a,this.fpsCounter=0)},WaterCanvas.prototype.getFps=function(){return this.fps},WaterCanvas.prototype.setLightRefraction=function(a){this.lightRefraction=a},WaterCanvas.prototype.setLightReflection=function(a){this.lightReflection=a},WaterModel=function(a,b,c){if(c=c||{},this.resolution=c.resolution||2,this.interpolate=c.interpolate||!1,this.damping=c.damping||.985,this.clipping=c.clipping||5,this.maxFps=c.maxFps||30,this.showStats=c.showStats||!1,this.evolveThreshold=c.evolveThreshold||.05,this.width=Math.ceil(a/this.resolution),this.height=Math.ceil(b/this.resolution),this.resetSizeAndResolution(a,b,this.resolution),this.swapMap,this.setMaxFps(this.maxFps),this.evolving=!1,this.fps=-1,this.showStats){this.fpsCounter=0,this.prevMs=0;var d=this;setInterval(function(){d.findFps()},1e3)}},WaterModel.prototype.getWater=function(a,b){var c,d,e,f,g,h,i;return xTrans=a/this.resolution,yTrans=b/this.resolution,this.interpolate&&1!=this.resolution?(xF=Math.floor(xTrans),yF=Math.floor(yTrans),xC=Math.ceil(xTrans),yC=Math.ceil(yTrans),xC>this.width-1||yC>this.height-1?0:(c=this.depthMap1[xF][yF],d=this.depthMap1[xC][yF],e=this.depthMap1[xF][yC],f=this.depthMap1[xC][yC],g=xC-xTrans,h=yC-yTrans,i=f*(1-g)*(1-h)+e*g*(1-h)+d*h*(1-g)+c*g*h)):(xF=Math.floor(xTrans),yF=Math.floor(yTrans),xF>this.width-1||yF>this.height-1?0:this.depthMap1[xF][yF])},WaterModel.prototype.setInterpolation=function(a){this.interpolate=a},WaterModel.prototype.touchWater=function(a,b,c,d){var e,f;for(this.evolving=!0,a=Math.floor(a/this.resolution),b=Math.floor(b/this.resolution),(d.length>4||d[0].length>4)&&(a-=d.length/2,b-=d[0].length/2),0>a&&(a=0),0>b&&(b=0),a>this.width&&(a=this.width),b>this.height&&(b=this.height),e=0;e<d.length;e++)for(f=0;f<d[0].length;f++)a+e>=0&&b+f>=0&&a+e<=this.width-1&&b+f<=this.height-1&&(this.depthMap1[a+e][b+f]-=d[e][f]*c)},WaterModel.prototype.renderNextFrame=function(){var a,b,c;if(this.evolving){for(this.evolving=!1,a=0;a<this.width;a++)for(b=0;b<this.height;b++)c=(0==a?0:this.depthMap1[a-1][b])+(a==this.width-1?0:this.depthMap1[a+1][b])+(0==b?0:this.depthMap1[a][b-1])+(b==this.height-1?0:this.depthMap1[a][b+1]),c=(c/2-this.depthMap2[a][b])*this.damping,c>this.clipping&&(c=this.clipping),c<-this.clipping&&(c=-this.clipping),Math.abs(c)>this.evolveThreshold&&(this.evolving=!0),this.depthMap2[a][b]=c;this.swapMap=this.depthMap1,this.depthMap1=this.depthMap2,this.depthMap2=this.swapMap,this.fpsCounter++}},WaterModel.prototype.isEvolving=function(){return this.evolving},WaterModel.prototype.findFps=function(){var a,b;this.showStats&&(a=(new Date).getTime(),b=a-this.prevMs,this.fps=Math.round(10*(1e3*this.fpsCounter/b))/10,this.prevMs=a,this.fpsCounter=0)},WaterModel.prototype.getFps=function(){return this.fps},WaterModel.prototype.setMaxFps=function(a){this.maxFps=a,clearInterval(this.maxFpsInterval);var b=this;this.maxFps>0&&(this.maxFpsInterval=setInterval(function(){b.renderNextFrame()},1e3/this.maxFps))},WaterModel.prototype.setDamping=function(a){this.damping=a},WaterModel.prototype.resetSizeAndResolution=function(a,b,c){var d,e;for(this.width=Math.ceil(a/c),this.height=Math.ceil(b/c),this.resolution=c,this.depthMap1=new Array(this.width),this.depthMap2=new Array(this.width),d=0;d<this.width;d++)for(this.depthMap1[d]=new Array(this.height),this.depthMap2[d]=new Array(this.height),e=0;e<this.height;e++)this.depthMap1[d][e]=0,this.depthMap2[d][e]=0},RainMaker=function(a,b,c,d){this.width=a,this.height=b,this.waterModel=c,this.raindrop2dArray=d,this.rainMinPressure=1,this.rainMaxPressure=3},RainMaker.prototype.raindrop=function(){var a=Math.floor(Math.random()*this.width),b=Math.floor(Math.random()*this.height);this.waterModel.touchWater(a,b,this.rainMinPressure+Math.random()*this.rainMaxPressure,this.raindrop2dArray)},RainMaker.prototype.setRaindropsPerSecond=function(a){if(this.rps=a,clearInterval(this.rainInterval),this.rps>0){var b=this;this.rainInterval=setInterval(function(){b.raindrop()},1e3/this.rps)}},RainMaker.prototype.setRainMinPressure=function(a){this.rainMinPressure=a},RainMaker.prototype.setRainMaxPressure=function(a){this.rainMaxPressure=a},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),d("water-left"),d("water-right")}();